name: Build and Deploy

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
  workflow_dispatch:

jobs:
  # codeguru-security:
  #   name: ğŸ”’ CodeGuru Security Scan
  #   uses: ./.github/workflows/codeguru-security.yml

  build-deploy:
    name: ğŸš€ Build and Deploy
    # needs: [codeguru-security]
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read
      actions: read
      security-events: write

    steps:
      - name: â¬‡ï¸ Checkout Repo
        uses: actions/checkout@v4
      - name: ğŸ”‘ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::141673609209:role/GitHubActionsElasticBeanstalkRole
          aws-region: us-east-1
          role-session-name: GitHubActionScript
      - name: ğŸ’ Set up Ruby 3.2.2
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2.2
      - name: ğŸ“¦ Install Bundler
        run: gem install bundler
      - name: ğŸ“¥ Install Dependencies
        run: |
          echo "Installing gem dependencies..."
          bundle install
      - name: ğŸ‘®â€â™‚ï¸ Run RuboCop
        run: |
          echo "Running bundle exec rubocop..."
          bundle exec rubocop
      - name: ğŸ§ª Run Tests
        run: |
          echo "Running tests..."
          # Replace with your actual test command
          # e.g., bundle exec rspec
      - name: ğŸ—ï¸ Build Artifact
        run: |
          echo "Building artifact..."
          zip -r deploy.zip . -x '*.git*' 'vendor/bundle/*' 'log/*' 'tmp/*' 'test/*' 'spec/*'
      - name: ğŸš€ Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v20
        with:
          application_name: Navigate-api
          environment_name: Navigate-api-env
          version_label: ${{ github.sha }}
          region: us-east-1
          deployment_package: deploy.zip
